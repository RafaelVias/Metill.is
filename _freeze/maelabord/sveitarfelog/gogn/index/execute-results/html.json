{
  "hash": "e63e4bc2a6f33298ef145df53ee2be75",
  "result": {
    "markdown": "---\ntitle: \"Ársreikningar sveitarfélaga\"\nsubtitle: \"Hvernig eru ársreikningagögn sveitarfélaga undirbúin fyrir birtingu í mælaborði Metils um?\"\nauthor: \n    -   name: \"Brynjólfur Gauti Guðrúnar Jónsson\"\n        url: \"https://twitter.com/bgautijonsson\"\n        affiliation: \"Tölfræði, Raunvísindadeild Háskóla Íslands\"\n        affiliation-url: \"https://www.hi.is/tolfraedi_0\"\ndate: \"2023/04/13\"\nformat: \n    html:\n        code-fold: show\n        smooth-scroll: true\n        link-external-newwindow: true\n        toc: true\n        toc-location: right\neditor: source\ndraft: false\ntitle-block-banner: true\ncategories:\n    - stjórnmál\n    - efnahagur\n    - ársreikningar\n    - sveitarfélög\nexecute: \n  echo: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(janitor)\nlibrary(visitalaneysluverds)\nlibrary(hagstofa)\nlibrary(arrow)\nlibrary(googledrive)\nlibrary(googlesheets4)\n```\n:::\n\n\n## Mannfjöldi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/mannfjoldi/2_byggdir/sveitarfelog/MAN02005.px\"\nmannfjoldi <- hg_data(url) |> \n  filter(\n    Aldur == \"Alls\",\n    Kyn == \"Alls\",\n    Sveitarfélag != \"Alls\"\n  ) |> \n  collect() |> \n  clean_names() |> \n  rename(mannfjoldi = 5) |> \n  select(-aldur, -kyn) |> \n  mutate(ar = parse_number(ar))\n```\n:::\n\n\n## Efnahagur\n\n\n::: {.cell}\n\n```{.r .cell-code}\nefnahagur <- read_excel(\"net-efnahagsreikningur.xlsx\", skip = 4) |> \n  clean_names() |> \n  fill(ar, sveitarfelag, hluti) |> \n  filter(\n    tegund2 %in% c(\n      \"Veltufjármunir Total\", \n      \"Varanlegir rekstrarfjármunir\", \n      \"Áhættufjármunir og langtímakröfur\",\n      \"Skuldbindingar\", \n      \"Langtímaskuldir\",\n      \"Skammtímaskuldir\", \n      \"Eigið fé\"\n    ) | tegund %in% c(\n      \"Skammtímakröfur á eigin fyrirtæki\",\n      \"Aðrir veltufjármunir\"\n    )\n  ) |> \n  mutate(\n    tegund2 = ifelse(is.na(tegund2), tegund, tegund2) |>\n      str_replace(\" Total\", \"\")\n  ) |> \n  select(-tegund) |> \n  mutate(\n    ar = parse_number(ar),\n    sveitarfelag = str_sub(sveitarfelag, start = 6)\n  )\n\nefnahagur\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 26,514 × 6\n      ar sveitarfelag    hluti        tegund3 tegund2                      total\n   <dbl> <chr>           <chr>        <chr>   <chr>                        <dbl>\n 1  2021 Reykjavíkurborg A_hluti      <NA>    Varanlegir rekstrarfjármun… 1.76e8\n 2  2021 Reykjavíkurborg A_hluti      <NA>    Áhættufjármunir og langtím… 2.37e7\n 3  2021 Reykjavíkurborg A_hluti      <NA>    Skammtímakröfur á eigin fy… 3.40e5\n 4  2021 Reykjavíkurborg A_hluti      <NA>    Aðrir veltufjármunir        1.53e7\n 5  2021 Reykjavíkurborg A_hluti      <NA>    Veltufjármunir              3.65e7\n 6  2021 Reykjavíkurborg A_hluti      <NA>    Eigið fé                    9.19e7\n 7  2021 Reykjavíkurborg A_hluti      <NA>    Skuldbindingar              3.44e7\n 8  2021 Reykjavíkurborg A_hluti      <NA>    Langtímaskuldir             8.51e7\n 9  2021 Reykjavíkurborg A_hluti      <NA>    Skammtímaskuldir            2.51e7\n10  2021 Reykjavíkurborg A_og_B_hluti <NA>    Varanlegir rekstrarfjármun… 6.87e8\n# ℹ 26,504 more rows\n```\n:::\n:::\n\n\n\n## Rekstur\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrekstur <- read_excel(\"net-rekstrarreikningur.xlsx\", skip = 4) |> \n  clean_names() |> \n  fill(ar, sveitarfelag, hluti) |> \n  filter(\n    tegund2 %in% c(\n      \"Gjöld Total\", \n      \"Tekjur Total\",\n      \"Rekstrarniðurstaða Total\"\n    ) | tegund %in% c(\n      \"Afskriftir\", \n      \"Breyting lífeyrisskuldbindinga\",\n      \"Fjármagnsliðir\",\n      \"Óreglulegir liðir\",\n      \"Framlag Jöfnunarsjóðs\", \n      \"Skatttekjur án Jöfnunarsjóðs\",\n      \"Laun og launatengd gjöld\"\n    )\n  ) |> \n  mutate(\n    tegund2 = ifelse(is.na(tegund2), tegund, tegund2) |> \n      str_replace(\" Total\", \"\")\n  ) |> \n  select(-tegund) |> \n  mutate(\n    ar = parse_number(ar),\n    sveitarfelag = str_sub(sveitarfelag, start = 6)\n  )\n```\n:::\n\n\n\n\n## Sjóðsstreymi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsjodsstreymi <- read_excel(\"net-sjodsstreymi.xlsx\", skip = 4) |> \n  clean_names() |> \n  fill(ar, sveitarfelag, hluti, tegund2) |> \n  mutate(\n    ar = parse_number(ar),\n    sveitarfelag = str_sub(sveitarfelag, start = 6)\n  ) |> \n  filter(\n    tegund2 %in% c(\n      \"Veltufé frá rekstri Total\", \n      \"Fjárfestingarhreyfingar Total\") | \n      tegund %in% c(\n        \"Afborganir langtímalána\",\n        \"Aðrar fjármögnunarhreyfingar\",\n        \"Tekin ný langtímalán\",\n        \"Fjárfesting í varanlegum rekstrarfjármunum\"\n      )\n  ) |>\n  mutate(\n    tegund2 = ifelse(is.na(tegund), tegund2, tegund) |>\n      str_replace(\" Total\", \"\")\n  ) |> \n  select(-tegund) |> \n  mutate(\n    total = coalesce(total, 0)\n  )\n```\n:::\n\n\n\n## Tenging\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- efnahagur |> \n  select(-tegund3) |> \n  pivot_wider(names_from = tegund2, values_from = total) |> \n  inner_join(\n    rekstur |> \n      pivot_wider(names_from = tegund2, values_from = total),\n    by = c(\"ar\", \"sveitarfelag\", \"hluti\")\n  ) |> \n  inner_join(\n    sjodsstreymi |> \n      pivot_wider(names_from = tegund2, values_from = total),\n    by = c(\"ar\", \"sveitarfelag\", \"hluti\")\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  skimr::skim()\n```\n\n::: {.cell-output-display}\nTable: Data summary\n\n|                         |     |\n|:------------------------|:----|\n|Name                     |d    |\n|Number of rows           |2946 |\n|Number of columns        |28   |\n|_______________________  |     |\n|Column type frequency:   |     |\n|character                |2    |\n|numeric                  |26   |\n|________________________ |     |\n|Group variables          |None |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|sveitarfelag  |         0|             1|   8|  29|     0|       78|          0|\n|hluti         |         0|             1|   7|  12|     0|        2|          0|\n\n\n**Variable type: numeric**\n\n|skim_variable                              | n_missing| complete_rate|       mean|          sd|        p0|        p25|      p50|        p75|      p100|hist  |\n|:------------------------------------------|---------:|-------------:|----------:|-----------:|---------:|----------:|--------:|----------:|---------:|:-----|\n|ar                                         |         0|             1|    2011.36|        5.74|      2002|    2006.00|   2011.0|    2016.00|      2021|▇▇▇▇▇ |\n|Varanlegir rekstrarfjármunir               |         0|             1| 6624957.10| 36051950.54|      5116|  278415.25| 799952.0| 2850725.00| 687356705|▇▁▁▁▁ |\n|Áhættufjármunir og langtímakröfur          |         0|             1|  852135.07|  3125057.05|         0|   51730.00| 133711.0|  429874.50|  36071319|▇▁▁▁▁ |\n|Skammtímakröfur á eigin fyrirtæki          |         0|             1|   59360.99|   177121.77|   -303230|       0.00|      0.0|   41883.25|   3842587|▇▁▁▁▁ |\n|Aðrir veltufjármunir                       |         0|             1|  400014.33|  1785970.70|         0|   20509.00|  65826.1|  171302.75|  30423739|▇▁▁▁▁ |\n|Veltufjármunir                             |         0|             1|  979396.69|  4014476.97|      5481|   89840.25| 195424.0|  578573.75|  83647325|▇▁▁▁▁ |\n|Eigið fé                                   |         0|             1| 3407509.12| 18745034.65|  -1653340|  242396.50| 526680.0| 1479685.50| 383263977|▇▁▁▁▁ |\n|Skuldbindingar                             |         0|             1|  918557.10|  3702651.37|         0|       0.00|  55855.5|  441199.50|  56048014|▇▁▁▁▁ |\n|Langtímaskuldir                            |         0|             1| 3279985.20| 17902106.72|         0|   62270.00| 345244.5| 1161922.50| 293362724|▇▁▁▁▁ |\n|Skammtímaskuldir                           |         0|             1|  850437.52|  3526533.76|       205|   43540.50| 142088.0|  393441.75|  57891584|▇▁▁▁▁ |\n|Skatttekjur án Jöfnunarsjóðs               |         0|             1| 2138379.79|  8100306.66|      7636|  137077.00| 362992.5| 1086497.75| 110501161|▇▁▁▁▁ |\n|Framlag Jöfnunarsjóðs                      |         0|             1|  348988.64|   713484.53|         0|   64818.00| 153872.0|  328042.00|   8761951|▇▁▁▁▁ |\n|Tekjur                                     |         0|             1| 3416476.78| 13131987.60|     12600|  262189.50| 668481.0| 1912667.75| 202598663|▇▁▁▁▁ |\n|Laun og launatengd gjöld                   |         0|             1| 1663137.44|  6233491.92|       874|  115040.00| 327390.0|  961997.75|  99466329|▇▁▁▁▁ |\n|Breyting lífeyrisskuldbindinga             |         0|             1|  106124.07|   590316.00|  -1531587|       0.00|   3643.0|   39447.25|  14666288|▇▁▁▁▁ |\n|Afskriftir                                 |         0|             1|  215721.42|  1193013.54|         0|   11210.58|  30666.5|   89919.50|  21052234|▇▁▁▁▁ |\n|Gjöld                                      |         0|             1| 3215724.00| 12196422.03|     13862|  257642.00| 644912.0| 1830874.00| 181811243|▇▁▁▁▁ |\n|Fjármagnsliðir                             |         0|             1| -180280.93|  2117285.13| -99783794|  -58652.25|  -9811.5|    2448.50|  10505376|▁▁▁▁▇ |\n|Óreglulegir liðir                          |         0|             1|   49837.20|   706343.64|  -6171386|       0.00|      0.0|       0.00|  20174498|▁▇▁▁▁ |\n|Rekstrarniðurstaða                         |         0|             1|   70309.06|  1835932.97| -71495906|  -17679.75|   9537.0|   62336.50|  28027176|▁▁▁▇▁ |\n|Veltufé frá rekstri                        |         0|             1|  411437.66|  2144372.78|  -2583086|   13206.50|  52313.0|  200575.75|  39602982|▇▁▁▁▁ |\n|Fjárfesting í varanlegum rekstrarfjármunum |         0|             1| -513171.39|  2656269.07| -48339094| -219702.00| -57540.5|  -13798.20|   1599022|▁▁▁▁▇ |\n|Fjárfestingarhreyfingar                    |         0|             1| -387395.63|  2390151.84| -48811242| -185058.00| -43222.5|   -4990.00|  29084625|▁▁▁▇▁ |\n|Tekin ný langtímalán                       |         0|             1|  398224.62|  2112577.99|   -170501|       0.00|  13050.0|  140000.00|  44594536|▇▁▁▁▁ |\n|Afborganir langtímalána                    |         0|             1| -331787.59|  1579268.10| -28501261| -146012.00| -42950.0|   -7370.58|     94019|▁▁▁▁▇ |\n|Aðrar fjármögnunarhreyfingar               |         0|             1|  -39852.38|   429502.42| -10357497|  -18051.75|      0.0|    3057.50|   2709554|▁▁▁▇▁ |\n:::\n:::\n\n\n### Sameining sveitarfélaga \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmulathing <- c(\n  \"Múlaþing\", \n  \"Fljótsdalshérað\", \n  \"Seyðisfjarðarkaupstaður\",\n  \"Borgarfjarðarhreppur\",\n  \"Djúpavogshreppur\"\n)\n\nsudurnesjabaer <- c(\n  \"Sandgerðisbær\", \n  \"Sveitarfélagið Garður\"\n)\n\nfjardabyggd <- c(\n  \"Breiðdalshreppur\",\n  \"Fjarðabyggð\"\n)\n\ngardabaer <- c(\n  \"Sveitarfélagið Álftanes\", \n  \"Garðabær\"\n)\n\nd <- d |> \n  mutate(\n    sveitarfelag = case_match(\n      sveitarfelag,\n      mulathing ~ \"Múlaþing\",\n      sudurnesjabaer ~ \"Suðurnesjabær\",\n      fjardabyggd ~ \"Fjarðabyggð\",\n      gardabaer ~ \"Garðabær\",\n      sveitarfelag ~ sveitarfelag\n    )\n  )\n```\n:::\n\n\n\n## Reikna breytur\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> mutate(\n  heildarskuldir = `Skuldbindingar` + `Langtímaskuldir` + `Skammtímaskuldir`,\n  eignir = `Varanlegir rekstrarfjármunir` + `Áhættufjármunir og langtímakröfur` + `Veltufjármunir`\n)\n\nd\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,946 × 30\n      ar sveitarfelag        hluti Varanlegir rekstrarf…¹ Áhættufjármunir og l…²\n   <dbl> <chr>               <chr>                  <dbl>                  <dbl>\n 1  2021 Reykjavíkurborg     A_hl…             176322020.              23656378.\n 2  2021 Reykjavíkurborg     A_og…             687356705.              19562270.\n 3  2021 Kópavogsbær         A_hl…              50426813                6645782 \n 4  2021 Kópavogsbær         A_og…              72724186                3492671 \n 5  2021 Seltjarnarnesbær    A_hl…               6426856                2438974 \n 6  2021 Seltjarnarnesbær    A_og…               7904716                1753980 \n 7  2021 Garðabær            A_hl…              32025217                2717438 \n 8  2021 Garðabær            A_og…              37142377                3236263 \n 9  2021 Hafnarfjarðarkaups… A_hl…              43677510                6140126 \n10  2021 Hafnarfjarðarkaups… A_og…              60521291                5530969 \n# ℹ 2,936 more rows\n# ℹ abbreviated names: ¹​`Varanlegir rekstrarfjármunir`,\n#   ²​`Áhættufjármunir og langtímakröfur`\n# ℹ 25 more variables: `Skammtímakröfur á eigin fyrirtæki` <dbl>,\n#   `Aðrir veltufjármunir` <dbl>, Veltufjármunir <dbl>, `Eigið fé` <dbl>,\n#   Skuldbindingar <dbl>, Langtímaskuldir <dbl>, Skammtímaskuldir <dbl>,\n#   `Skatttekjur án Jöfnunarsjóðs` <dbl>, `Framlag Jöfnunarsjóðs` <dbl>, …\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  select(\n    ar, \n    sveitarfelag,\n    hluti,\n    heildarskuldir,\n    eignir,\n    tekjur = \"Tekjur\", \n    skatttekjur_an_jofnundarsjods = \"Skatttekjur án Jöfnunarsjóðs\",\n    framlag_jofnunarsjods = \"Framlag Jöfnunarsjóðs\",\n    gjold = \"Gjöld\", \n    afskriftir = \"Afskriftir\",\n    fjarmagnslidir = \"Fjármagnsliðir\", \n    oreglulegir_lidir = \"Óreglulegir liðir\",\n    rekstrarnidurstada = \"Rekstrarniðurstaða\",\n    breyting_lifeyrisskuldbindinga = \"Breyting lífeyrisskuldbindinga\",\n    afborganir_langtimalana = \"Afborganir langtímalána\",\n    tekin_ny_langtimalan = \"Tekin ný langtímalán\",\n    adrar_fjarmognunarhreyfingar = \"Aðrar fjármögnunarhreyfingar\",\n    ny_fjarfesting = \"Fjárfesting í varanlegum rekstrarfjármunum\",\n    eigid_fe = \"Eigið fé\", \n    veltufjarmunir = \"Veltufjármunir\", \n    skammtimakrofur_eigin_fyrirtaeki = \"Skammtímakröfur á eigin fyrirtæki\",\n    handbaert_fe = \"Aðrir veltufjármunir\",\n    skammtimaskuldir = \"Skammtímaskuldir\", \n    fjarfestingarhreyfingar = \"Fjárfestingarhreyfingar\", \n    nyjar_langtimaskuldir = \"Tekin ný langtímalán\",\n    launagjold = \"Laun og launatengd gjöld\",\n    veltufe = \"Veltufé frá rekstri\"\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  group_by(sveitarfelag, ar, hluti) |> \n  summarise_at(\n    vars(heildarskuldir:veltufe), \n    ~ 1000 * sum(.x)\n  ) |> \n  ungroup()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  mutate(\n    hluti = fct_recode(\n      hluti,\n      \"A-hluti\" = \"A_hluti\",\n      \"A og B-hluti\" = \"A_og_B_hluti\"\n    )\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngdrive_data <- read_sheet(\"https://docs.google.com/spreadsheets/d/1g4aY4ZDhB2NgvgqTwAS33NgVNbhkitcs3fJLQHWEi6E/edit#gid=0\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- gdrive_data |> \n  mutate_at(\n    vars(-ar, -sveitarfelag, -hluti),\n    ~ 1000 * .x\n  ) |> \n  mutate(\n    gjold = gjold + afskriftir\n  ) |> \n  bind_rows(\n    d\n  ) |> \n  arrange(\n    ar, sveitarfelag, hluti\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |> \n  inner_join(\n    mannfjoldi,\n    by = join_by(ar, sveitarfelag)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- d |>\n  mutate(\n    eiginfjarhlutfall = eigid_fe / eignir,\n    framlegd = tekjur - gjold + afskriftir,\n    framlegd_hlutf = framlegd / tekjur,\n    handbaert_fe_per_ibui = handbaert_fe / mannfjoldi,\n    heildarskuldir = heildarskuldir,\n    launagjold_per_ibui = launagjold / mannfjoldi,\n    launagjold_hlutf_gjold = launagjold / gjold,\n    nettoskuldir = heildarskuldir - veltufjarmunir + skammtimakrofur_eigin_fyrirtaeki,\n    nettoskuldir_hlutf_tekjur = nettoskuldir / tekjur,\n    rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,\n    rekstur_3_ar = rekstrarnidurstada + lag(rekstrarnidurstada, 1) + lag(rekstrarnidurstada, 2),\n    tekjur_3_ar = tekjur + lag(tekjur, 1) + lag(tekjur, 2),\n    rekstur_3_ar_hlutf_tekjur = rekstur_3_ar / tekjur_3_ar,\n    skattur_a_ibua = skatttekjur_an_jofnundarsjods / mannfjoldi,\n    skuldahlutfall = 1 - eiginfjarhlutfall,\n    skuldir_hlutf_tekjur = heildarskuldir / tekjur,\n    skuldir_per_ibui = heildarskuldir / mannfjoldi,\n    veltufe_hlutf_tekjur = veltufe / tekjur,\n    veltufjarhlutfall = veltufjarmunir / skammtimaskuldir,\n    veltufe_hlutf_afborganir = veltufe / afborganir_langtimalana,\n    fjarf_nylan = tekin_ny_langtimalan - ny_fjarfesting,\n    fjarfesting_hlutf_skuldir = fjarf_nylan / heildarskuldir,\n    .by = c(sveitarfelag, hluti)\n  )\n\nd |> \n  write_parquet(\n    \"total_data.parquet\"\n  )\n\nnames(d)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"ar\"                               \"sveitarfelag\"                    \n [3] \"hluti\"                            \"tekjur\"                          \n [5] \"gjold\"                            \"afskriftir\"                      \n [7] \"rekstrarnidurstada\"               \"skatttekjur_an_jofnundarsjóðs\"   \n [9] \"framlag_jofnunarsjods\"            \"launagjold\"                      \n[11] \"eignir\"                           \"veltufjarmunir\"                  \n[13] \"skammtimakrofur_eigin_fyrirtaeki\" \"eigid_fe\"                        \n[15] \"skammtimaskuldir\"                 \"heildarskuldir\"                  \n[17] \"veltufe\"                          \"handbaert_fe\"                    \n[19] \"afborganir_langtimalana\"          \"tekin_ny_langtimalan\"            \n[21] \"skatttekjur_an_jofnundarsjods\"    \"fjarmagnslidir\"                  \n[23] \"oreglulegir_lidir\"                \"breyting_lifeyrisskuldbindinga\"  \n[25] \"adrar_fjarmognunarhreyfingar\"     \"ny_fjarfesting\"                  \n[27] \"fjarfestingarhreyfingar\"          \"nyjar_langtimaskuldir\"           \n[29] \"mannfjoldi\"                       \"eiginfjarhlutfall\"               \n[31] \"framlegd\"                         \"framlegd_hlutf\"                  \n[33] \"handbaert_fe_per_ibui\"            \"launagjold_per_ibui\"             \n[35] \"launagjold_hlutf_gjold\"           \"nettoskuldir\"                    \n[37] \"nettoskuldir_hlutf_tekjur\"        \"rekstrarnidurstada_hlutf\"        \n[39] \"rekstur_3_ar\"                     \"tekjur_3_ar\"                     \n[41] \"rekstur_3_ar_hlutf_tekjur\"        \"skattur_a_ibua\"                  \n[43] \"skuldahlutfall\"                   \"skuldir_hlutf_tekjur\"            \n[45] \"skuldir_per_ibui\"                 \"veltufe_hlutf_tekjur\"            \n[47] \"veltufjarhlutfall\"                \"veltufe_hlutf_afborganir\"        \n[49] \"fjarf_nylan\"                      \"fjarfesting_hlutf_skuldir\"       \n```\n:::\n:::\n\n\n# Þróunargögn\n\n\n::: {.cell}\n\n```{.r .cell-code}\npercent_vars <- c(\n  \"Eiginfjárhlutfall\",\n  \"Framlegð sem hlutfall af tekjum\",\n  \"Handbært fé á íbúa\",\n  \"Launa- og launatengd gjöld sem hlutfall af útgjöldum\",\n  \"Nettóskuldir sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\",\n  \"Skuldahlutfall\",\n  \"Skuldir sem hlutfall af tekjum\",\n  \"Veltufé frá rekstri sem hlutfall af tekjum\",\n  \"Veltufjárhlutfall\"\n)\n\nthroun_data <- d |> \n  select(\n    sveitarfelag,\n    ar,\n    hluti,\n    # \"Heildarskuldir\" = heildarskuldir,\n    # \"Eignir\" = eignir,\n    # \"Tekjur\" = tekjur,\n    # \"Rekstrarniðurstaða\" = rekstrarnidurstada,\n    \"Eiginfjárhlutfall\" = eiginfjarhlutfall,\n    \"Framlegð sem hlutfall af tekjum\" = framlegd_hlutf,\n    \"Handbært fé á íbúa\" = handbaert_fe_per_ibui,\n    \"Launa- og launatengd gjöld á íbúa\" = launagjold_per_ibui,\n    \"Launa- og launatengd gjöld sem hlutfall af útgjöldum\" = launagjold_hlutf_gjold,\n    \"Nettóskuldir sem hlutfall af tekjum\" = nettoskuldir_hlutf_tekjur,\n    \"Rekstrarniðurstaða sem hlutfall af tekjum\" = rekstrarnidurstada_hlutf,\n    \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\" = rekstur_3_ar_hlutf_tekjur,\n    \"Útsvar og fasteignaskattur á íbúa\" = skattur_a_ibua,\n    \"Skuldahlutfall\" = skuldahlutfall,\n    \"Skuldir sem hlutfall af tekjum\" = skuldir_hlutf_tekjur,\n    \"Skuldir á íbúa\" = skuldir_per_ibui,\n    \"Veltufé frá rekstri sem hlutfall af tekjum\" = veltufe_hlutf_tekjur,\n    \"Veltufjárhlutfall\" = veltufjarhlutfall\n  ) |> \n  pivot_longer(\n    c(-sveitarfelag, -ar, -hluti),\n    names_to = \"name\",\n    values_to = \"y\"\n  ) |> \n  arrange(ar, hluti, sveitarfelag, name) |> \n  mutate(\n    is_percent = ifelse(\n      name %in% percent_vars,\n      TRUE,\n      FALSE\n    )\n  )\n\nthroun_data |> \n  write_parquet(\n    \"throun_data.parquet\"\n  )\n```\n:::\n\n\n# Dreifingargögn\n\n\n::: {.cell}\n\n```{.r .cell-code}\npercent_vars <- c(\n  \"Eiginfjárhlutfall\",\n  \"Framlegð sem hlutfall af tekjum\",\n  \"Handbært fé á íbúa\",\n  \"Launa- og launatengd gjöld sem hlutfall af gjöldum\",\n  \"Nettóskuldir sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða sem hlutfall af tekjum\",\n  \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\",\n  \"Skuldahlutfall\",\n  \"Skuldir sem hlutfall af tekjum\",\n  \"Veltufé frá rekstri sem hlutfall af tekjum\",\n  \"Veltufjárhlutfall\"\n)\n\ndreifing_data <- d |> \n  select(\n    ar,\n    sveitarfelag,\n    hluti,\n    # \"Heildarskuldir\" = heildarskuldir,\n    # \"Eignir\" = eignir,\n    # \"Tekjur\" = tekjur,\n    # \"Rekstrarniðurstaða\" = rekstrarnidurstada,\n    \"Eiginfjárhlutfall\" = eiginfjarhlutfall,\n    \"Framlegð sem hlutfall af tekjum\" = framlegd_hlutf,\n    \"Handbært fé á íbúa\" = handbaert_fe_per_ibui,\n    \"Launa- og launatengd gjöld á íbúa\" = launagjold_per_ibui,\n    \"Launa- og launatengd gjöld sem hlutfall af gjöldum\" = launagjold_hlutf_gjold,\n    \"Nettóskuldir sem hlutfall af tekjum\" = nettoskuldir_hlutf_tekjur,\n    \"Rekstrarniðurstaða sem hlutfall af tekjum\" = rekstrarnidurstada_hlutf,\n    \"Rekstrarniðurstaða undanfarinna 3 ára sem hlutfall af tekjum\" = rekstur_3_ar_hlutf_tekjur,\n    \"Útsvar og fasteignaskattur á íbúa\" = skattur_a_ibua,\n    \"Skuldahlutfall\" = skuldahlutfall,\n    \"Skuldir sem hlutfall af tekjum\" = skuldir_hlutf_tekjur,\n    \"Skuldir á íbúa\" = skuldir_per_ibui,\n    \"Veltufé frá rekstri sem hlutfall af tekjum\" = veltufe_hlutf_tekjur,\n    \"Veltufjárhlutfall\" = veltufjarhlutfall\n  ) |> \n  pivot_longer(\n    c(-sveitarfelag, -ar, -hluti),\n    names_to = \"name\",\n    values_to = \"y\"\n  ) |> \n  arrange(ar, hluti, sveitarfelag, name) |> \n  mutate(\n    is_percent = ifelse(\n      name %in% percent_vars,\n      TRUE,\n      FALSE\n    )\n  )\n\ndreifing_data |> \n  write_parquet(\n    \"dreifing_data.parquet\"\n  )\n\ndreifing_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 34,076 × 6\n      ar sveitarfelag      hluti        name                        y is_percent\n   <dbl> <chr>             <chr>        <chr>                   <dbl> <lgl>     \n 1  2002 Akraneskaupstaður A og B-hluti Eiginfjárhlutfall     6.03e-1 TRUE      \n 2  2002 Akraneskaupstaður A og B-hluti Framlegð sem hlutfa…  7.06e-2 TRUE      \n 3  2002 Akraneskaupstaður A og B-hluti Handbært fé á íbúa    1.42e+4 TRUE      \n 4  2002 Akraneskaupstaður A og B-hluti Launa- og launateng…  5.53e-1 TRUE      \n 5  2002 Akraneskaupstaður A og B-hluti Launa- og launateng…  1.71e+5 FALSE     \n 6  2002 Akraneskaupstaður A og B-hluti Nettóskuldir sem hl…  1.09e+0 TRUE      \n 7  2002 Akraneskaupstaður A og B-hluti Rekstrarniðurstaða …  3.35e-2 TRUE      \n 8  2002 Akraneskaupstaður A og B-hluti Rekstrarniðurstaða … NA       TRUE      \n 9  2002 Akraneskaupstaður A og B-hluti Skuldahlutfall        3.97e-1 TRUE      \n10  2002 Akraneskaupstaður A og B-hluti Skuldir sem hlutfal…  1.25e+0 TRUE      \n# ℹ 34,066 more rows\n```\n:::\n:::\n\n\n\n# Viðmiðsgögn\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvidmid_data <- d |> \n  filter(\n    ar >= 2010,\n  ) |> \n  select(\n    sveitarfelag, \n    ar, \n    hluti,\n    nettoskuldir_obs = nettoskuldir_hlutf_tekjur, \n    rekstrarnidurstada_obs = rekstur_3_ar_hlutf_tekjur, \n    framlegd_obs = framlegd_hlutf, \n    veltufe_obs = veltufe_hlutf_tekjur,\n    veltufjarhlutfall_obs = veltufjarhlutfall\n  ) |> \n  mutate(\n    framlegd_vidmid = nettoskuldir_obs/10,\n    veltufe_vidmid = nettoskuldir_obs/20,\n    rekstrarnidurstada_vidmid = 0,\n    veltufjarhlutfall_vidmid = 1,\n    nettoskuldir_vidmid = 1\n  ) |> \n  pivot_longer(c(-sveitarfelag, -ar, -hluti), names_to = c(\"name\", \"type\"), values_to = \"value\", names_sep = \"_\") |> \n  pivot_wider(names_from = type, values_from  = value) |> \n  mutate(\n    diff = obs - vidmid,\n    colour = diff > 0\n  ) \n\nvidmid_data |> \n  write_parquet(\n    \"vidmid_data.parquet\"\n  )\n\nvidmid_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7,330 × 8\n   sveitarfelag         ar hluti        name           obs vidmid    diff colour\n   <chr>             <dbl> <chr>        <chr>        <dbl>  <dbl>   <dbl> <lgl> \n 1 Akraneskaupstaður  2010 A og B-hluti nettoskul…  1.14   1       0.143  TRUE  \n 2 Akraneskaupstaður  2010 A og B-hluti rekstrarn… -0.0693 0      -0.0693 FALSE \n 3 Akraneskaupstaður  2010 A og B-hluti framlegd    0.0971 0.114  -0.0173 FALSE \n 4 Akraneskaupstaður  2010 A og B-hluti veltufe     0.159  0.0572  0.102  TRUE  \n 5 Akraneskaupstaður  2010 A og B-hluti veltufjar…  1.50   1       0.497  TRUE  \n 6 Akraneskaupstaður  2010 A-hluti      nettoskul…  1.18   1       0.182  TRUE  \n 7 Akraneskaupstaður  2010 A-hluti      rekstrarn… -0.0740 0      -0.0740 FALSE \n 8 Akraneskaupstaður  2010 A-hluti      framlegd    0.105  0.118  -0.0131 FALSE \n 9 Akraneskaupstaður  2010 A-hluti      veltufe     0.166  0.0591  0.106  TRUE  \n10 Akraneskaupstaður  2010 A-hluti      veltufjar…  1.42   1       0.420  TRUE  \n# ℹ 7,320 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# d <- d |>\n#   mutate(\n#     eiginfjarhlutfall = eigid_fe / eignir,\n#     framlegd = tekjur - gjold + afskriftir,\n#     framlegd_hlutf = framlegd / tekjur,\n#     handbaert_fe_per_ibui = handbaert_fe / mannfjoldi,\n#     heildarskuldir = heildarskuldir,\n#     hlutf_jofnunarsjods_skottum = framlag_jofnunarsjods / (framlag_jofnunarsjods + skatttekjur_an_jofnundarsjods),\n#     jofnunarsjodur_a_ibua = framlag_jofnunarsjods / mannfjoldi,\n#     launagjold_per_ibui = launagjold / mannfjoldi,\n#     launagjold_hlutf_gjold = launagjold / gjold,\n#     utgjold_jofnunarsjod = (0.0077 + 0.0099) * tekjur,\n#     netto_jofnunarsjod = framlag_jofnunarsjods - utgjold_jofnunarsjod,\n#     netto_jofnunarsjod_per_ibui = netto_jofnunarsjod / mannfjoldi,\n#     nettoskuldir = heildarskuldir - veltufjarmunir + skammtimakrofur_eigin_fyrirtaeki,\n#     nettoskuldir_hlutf_tekjur = nettoskuldir / tekjur,\n#     rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,\n#     rekstur_3_ar = rekstrarnidurstada + lag(rekstrarnidurstada, 1) + lag(rekstrarnidurstada, 2),\n#     tekjur_3_ar = tekjur + lag(tekjur, 1) + lag(tekjur, 2),\n#     rekstur_3_ar_hlutf_tekjur = rekstur_3_ar / tekjur_3_ar,\n#     skattur_a_ibua = skatttekjur_an_jofnundarsjóðs / mannfjoldi,\n#     skuldahlutfall = 1 - eiginfjarhlutfall,\n#     skuldir_hlutf_tekjur = heildarskuldir / tekjur,\n#     skuldir_per_ibui = heildarskuldir / mannfjoldi,\n#     timi_borga_skuldir = nettoskuldir / veltufe,\n#     timi_borga_skuldir = pmax(timi_borga_skuldir, 0),\n#     timi_borga_skuldir = ifelse(veltufe <= 0, 1e5, timi_borga_skuldir),\n#     veltufe_hlutf_tekjur = veltufe / tekjur,\n#     veltufjarhlutfall = veltufjarmunir / skammtimaskuldir\n#   ) |>\n#   inner_join(\n#     visitala,\n#     by = \"ar\"\n#   ) |>\n#   group_by(ar) |>\n#   mutate(hlutf_jofnunarsjod_utgjold = utgjold_jofnunarsjod / sum(utgjold_jofnunarsjod)) |>\n#   ungroup() |>\n#   arrange(ar, sveitarfelag, hluti) |>\n#   group_by(sveitarfelag, hluti) |>\n#   mutate(\n#     skuldaaukning_2021 = ifelse(sveitarfelag != \"Múlaþing\" & ar >= 2018, (heildarskuldir / cpi) / (heildarskuldir[ar == 2018] / cpi[ar == 2018]) - 1, NA),\n#     skuldaaukning = heildarskuldir / heildarskuldir[ar == max(ar)],\n#     rekstrarnidurstada_kjortimabil = sum(rekstrarnidurstada * (ar >= 2018)),\n#     tekjur_kjortimabil = sum(tekjur * (ar >= 2018)),\n#     rekstrarnidurstada_hlutf_kjortimabil = rekstrarnidurstada_kjortimabil / tekjur_kjortimabil,\n#     rekstrarnidurstada_per_ibui_kjortimabil = rekstrarnidurstada_kjortimabil / mean(mannfjoldi[ar %in% 2018:2021])\n#   ) |>\n#   ungroup()\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}