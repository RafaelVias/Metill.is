---
title: "Strætó"
pagetitle: "Strætó"
subtitle: "Hvað getum við lært af því hvernig Strætó bs. birtir tölurnar sínar?"
description: | 
    Í ársreikningi Strætó bs. frá 2021 má finna áhugaverða myndræna framsetningu á tölum. Hér skoða ég hvað við getum lært af þessu og hvernig við getum hjálpað þeim að koma gögnunum ennþá betur til skila.
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: "2022/09/28"
format: 
    html:
        smooth-scroll: true
        link-external-newwindow: true
editor: source
categories:
    - verðlag
    - strætó
image: image.png
twitter-card:
    image: image.png
---

```{r}
#| include: false
#| cache: false


library(cowplot)
library(tidyverse)
library(scales)
library(pxweb)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(plotly)
library(metill)
library(visitalaneysluverds)
library(ggtext)

theme_set(theme_metill())


d <- tibble(
  ar = 2012:2022,
  verd = c(350, 350, 350, 400, 420, 440, 460, 470, 480, 490, 550)
) |> 
  inner_join(
    vnv() |> 
      group_by(ar = year(date)) |> 
      summarise(
        cpi = mean(cpi)
      ) |> 
      mutate(
        cpi = cpi / cpi[ar == max(ar)]
      ),
    by = "ar"
  ) |> 
  mutate(raunverd = verd / cpi)

isk <- function(x) number(x, suffix = " kr", big.mark = ".", decimal.mark = ",", accuracy = 1)
hlutf <- function(x) percent(x, big.mark = ".", decimal.mark = ",", accuracy = 0.1)
```


Í [ársreikningi Strætó bs. frá 2021](https://straeto.is/media/2022/03/straetobs_arsreikningur_31122021_undirritad.pdf){target="_blank"} má finna þessar tvær myndir:

::: {layout-ncol=2 #hero-banner .column-screen style="border:none;"}

![](Figures/straeto1.png)

![](Figures/straeto2.png)

:::

Þetta er áhugaverð leið til að birta tímaröð af tölum. Vanalega viljum við að tíminn á x-ás byrji vinstra megin og fari svo hækkandi til hægri. Ég myndi t.d. vanalega teikna þessar myndir svona:


```{r}
#| column: page
#| fig-asp: 0.5
#| out-width: 100%
#| fig-width: 8


p <- tibble(
  ar = 2017:2021,
  "Eiginfjárhlutfall" = c(64, 49, 47, 40, 26)/100,
  "Langtímaskuldir/Eigið fé" = c(0, 56.3, 57.7, 77.8, 148.8)/100
) |> 
  pivot_longer(c(-ar)) |> 
  mutate(
    text = str_c(
      "Ár: ", ar, "\n",
      "Breyta: ", name, "\n",
      "Gildi: ", hlutf(value), "\n"
    )
  ) |> 
  ggplot(aes(ar, value, group = name, text = text)) +
  geom_line() +
  geom_point(size = 14, colour = "#FAF9F9") +
  geom_text(
    aes(
      label = percent(value)
    )
  ) +
  scale_x_continuous(
    limits = c(2016.5, 2021.5)
  ) +
  scale_y_continuous() +
  facet_wrap("name", ncol = 2, scales = "free") +
  labs(
    x = NULL,
    y = NULL,
    title = "Framsetning sem endurspeglar gögnin"
  ) +
  theme(axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

ggplotly(
  p,
  tooltip = "text"
)
```


Það er hins vegar frekar leitt við mína framsetningu að það sést of vel hvað reksturinn gengur illa. Hin framsetningin er því bara frekar góð

```{r}
#| column: page
#| fig-asp: 0.5
#| out-width: 100%
#| fig-width: 8


p <- tibble(
  ar = 2017:2021,
  "Eiginfjárhlutfall" = c(64, 49, 47, 40, 26)/100,
  "Langtímaskuldir/Eigið fé" = c(0, 56.3, 57.7, 77.8, 148.8)/100
) |> 
  pivot_longer(c(-ar)) |> 
  mutate(
    text = str_c(
      "Ár: ", ar, "\n",
      "Breyta: ", name, "\n",
      "Gildi: ", hlutf(value), "\n"
    )
  ) |> 
  ggplot(aes(-ar, value, group = name, text = text)) +
  geom_line() +
  geom_point(size = 14, colour = "#FAF9F9") +
  geom_text(
    aes(
      label = percent(value)
    )
  ) +
  scale_x_continuous(
    limits = c(-2021.5, -2016.5),
    breaks = -(2017:2021),
    labels = 2017:2021
  ) +
  scale_y_continuous() +
  facet_wrap("name", ncol = 2, scales = "free") +
  labs(
    x = NULL,
    y = NULL,
    title = "Framsetning fyrir hugsjónafólk sem hlær síðast"
  ) +
  theme(axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

ggplotly(
  p,
  tooltip = "text"
)
```

# Fargjald

Hérna kemur kafli þar sem við beitum lexíum frá Strætó bs. á fargjaldsverðið

```{r}
#| column: page
#| fig-asp: 0.621

plot_dat <- d |> 
  pivot_longer(c(verd, raunverd)) |> 
  group_by(ar) |> 
  mutate(
    text = str_c(
      "Ár: ", ar, "\n",
      ifelse(name == "verd", "<b>", ""),
      "Verð (hvers árs): ", value[name == "verd"] |> isk(), "\n",
      ifelse(name == "verd", "</b>", ""),
      ifelse(name == "raunverd", "<b>", ""),
      "Verð (fast): ", value[name == "raunverd"] |> isk(), 
      ifelse(name == "raunverd", "</b>", "")
    )
  )

p <- plot_dat |> 
  ggplot(aes(ar, value, text = text)) +
  geom_line(aes(col = name, group = name)) +
  geom_point(aes(col = name, group = name), size = 2) +
  scale_x_continuous(
    breaks = 2012:2022
  ) +
  scale_y_continuous() +
  scale_colour_manual(
    values = c("#7570b3", "#d95f02")
  ) +
  theme(plot.subtitle = element_markdown(),
        legend.position = "none") +
  labs(
    x = NULL,
    y = NULL,
    title = " Verð staks fargjalds í strætó",
    subtitle = str_c("Sýnt fyrir ",
                     "<b style='color:#7570b3;text-'>", "fast verðlag", "</b>",
                     " og ",
                     "<b style='color:#d95f02;'>", "verðlag hvers árs", "</b>"),
    caption = "Metill.is"
  ) 

ggplotly(
  p,
  tooltip = "text"
)


ggsave(
  p + 
    scale_x_tufte(
      breaks = 2012:2022,
      labels = 2022:2012
    ) +
    scale_y_tufte(
      breaks = tufte_breaks(plot_dat$value),
      labels = label_number(suffix = " kr")
    ),
  filename = "image.png",
  width = 8,
  height = 0.621 * 8
)
```



```{r}
plot_arrangement <- function() {
  list(
    geom_line(aes(col = name, group = name), size = 1),
    geom_point(aes(group = name), size = 3.4, shape = "square"),
    geom_point(aes(col = name, group = name), size = 2.3, shape = "square"),
    geom_point(aes(group = name), size = 2.3, shape = "square", col = "white", alpha = 0.5)
  )
}

p <- plot_dat |> 
  ggplot(aes(-ar, value, text = text)) +
  plot_arrangement() +
  theme_half_open() +
  scale_x_tufte(
    breaks = -(2012:2022),
    labels = 2012:2022
  ) +
  scale_y_tufte(
    breaks = tufte_breaks(plot_dat$value),
    labels = label_number(suffix = " kr")
  )+
  scale_colour_manual(
    values = c("#386cb0", "#fdc086")
  ) +
  theme(plot.subtitle = element_markdown(),
        legend.position = "none") +
  labs(
    x = NULL,
    y = NULL,
    title = "Verð staks fargjalds í strætó",
    subtitle = str_c("Sýnt fyrir ",
                     "<b style='color:#386cb0;text-'>", "fast verðlag", "</b>",
                     " og ",
                     "<b style='color:#fdc086;'>", "verðlag hvers árs", "</b>")
  ) 

ggsave(
  p,
  filename = "image_pyngjan_invx.png",
  width = 8,
  height = 0.621 * 8,
  bg = "white"
)

p <- plot_dat |> 
  ggplot(aes(ar, -value, text = text)) +
  plot_arrangement() +
  theme_half_open() +
  scale_x_tufte(
    breaks = 2012:2022,
    labels = 2012:2022
  ) +
  scale_y_tufte(
    breaks = -tufte_breaks(plot_dat$value),
    labels = function(x) isk(abs(x))
  )+
  scale_colour_manual(
    values = c("#386cb0", "#fdc086")
  ) +
  theme(plot.subtitle = element_markdown(),
        legend.position = "none") +
  labs(
    x = NULL,
    y = NULL,
    title = "Verð staks fargjalds í strætó",
    subtitle = str_c("Sýnt fyrir ",
                     "<b style='color:#386cb0;text-'>", "fast verðlag", "</b>",
                     " og ",
                     "<b style='color:#fdc086;'>", "verðlag hvers árs", "</b>")
  ) 

ggsave(
  p,
  filename = "image_pyngjan_invy.png",
  width = 8,
  height = 0.621 * 8,
  bg = "white"
)

p <- plot_dat |> 
  ggplot(aes(-ar, -value, text = text)) +
  plot_arrangement() +
  theme_half_open() +
  scale_x_tufte(
    breaks = -(2012:2022),
    labels = 2012:2022
  ) +
  scale_y_tufte(
    breaks = -tufte_breaks(plot_dat$value),
    labels = function(x) isk(abs(x))
  )+
  scale_colour_manual(
    values = c("#386cb0", "#fdc086")
  ) +
  theme(plot.subtitle = element_markdown(),
        legend.position = "none") +
  labs(
    x = NULL,
    y = NULL,
    title = "Verð staks fargjalds í strætó",
    subtitle = str_c("Sýnt fyrir ",
                     "<b style='color:#386cb0;text-'>", "fast verðlag", "</b>",
                     " og ",
                     "<b style='color:#fdc086;'>", "verðlag hvers árs", "</b>")
  ) 

ggsave(
  p,
  filename = "image_pyngjan_invxy.png",
  width = 8,
  height = 0.621 * 8,
  bg = "white"
)
```

