{"title":"Alþingiskosningar","markdown":{"yaml":{"title":"Alþingiskosningar","pagetitle":"Alþingiskosningar","subtitle":"A subtitle","description":"A description of this stuff!\n","author":[{"name":"Brynjólfur Gauti Guðrúnar Jónsson","url":"https://twitter.com/bgautijonsson","affiliation":"Tölfræði, Raunvísindadeild Háskóla Íslands","affiliation-url":"https://www.hi.is/tolfraedi_0"}],"date":"2022/09/17","format":{"html":{"code-fold":true,"page-layout":"full","smooth-scroll":true,"link-external-newwindow":true}},"execute":{"echo":false,"warning":false,"cache":false},"editor":"source","draft":false,"title-block-banner":true,"categories":["stjórnmál","kosningar","R","íslenska"],"href":"posts/kosningar/index.qmd","image":"Figures/thingmenn_atkvaedi_tw.png"},"headingText":"| include: false","containsRefs":false,"markdown":"\n\n\n```{r}\n\nlibrary(cowplot)\nlibrary(tidyverse)\nlibrary(scales)\nlibrary(ggthemes)\nlibrary(kableExtra)\nlibrary(gganimate)\nlibrary(lubridate)\nlibrary(geomtextpath)\nlibrary(ggtext)\nlibrary(readxl)\nlibrary(janitor)\nlibrary(plotly)\nlibrary(config)\nlibrary(DBI)\nlibrary(visitalaneysluverds)\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(ggthemes)\nlibrary(cowplot)\nlibrary(scales)\nlibrary(visitalaneysluverds)\nlibrary(feather)\nlibrary(gganimate)\nlibrary(metill)\nlibrary(patchwork)\ntheme_set(theme_metill())\n\n```\n\n```{r}\nusr <- config::get(\"postgres_user\")\ncon <- dbConnect(RPostgres::Postgres(), \n                 dbname = usr$dbname, \n                 host = usr$host,\n                 port = usr$port, \n                 user = usr$username, \n                 password = usr$password)\n\nisk <- function(x, scale = 1e6, suffix = \" mkr\") number(x / scale, suffix = suffix, big.mark = \".\", decimal.mark = \",\")\nhlutf <- label_percent(accuracy = 0.1, big.mark = \".\", decimal.mark = \",\")\n```\n\n\n```{r}\nd <- tbl(con, \"arsreikningar_stjornmalaflokka\") |> \n    collect() |> \n    mutate_all(~ ifelse(is.na(.), 0, .)) |> \n    inner_join(\n        vnv() |> \n            group_by(ar = year(date)) |> \n            summarise(cpi = mean(cpi)) |> \n            mutate(cpi = cpi / cpi[ar == max(ar)]),\n        by = \"ar\"\n    ) |> \n    mutate(\n        flokkur = case_when(\n            flokkur == \"Flokkur Fólksins\" ~ \"Flokkur fólksins\",\n            flokkur == \"Framsóknarflokkurinn\" ~ \"Framsóknarflokkur\",\n            TRUE ~ flokkur\n        )\n    ) |> \n    inner_join(\n        flokkar_palette(),\n        by = \"flokkur\"\n    ) |> \n    left_join(\n        tbl(con, \"atkvaedi_stjornmalaflokka\") |> \n            filter(ar >= 2007) |> \n            collect() |> \n            mutate(ar = ifelse(ar == 2021, 2020, ar)),\n        by = c(\"flokkur\", \"ar\")\n    ) |> \n    left_join(\n        tbl(con, \"thingmenn_stjornmalaflokka\") |> \n            filter(ar >= 2007) |> \n            collect() |> \n            mutate(ar = ifelse(ar == 2021, 2020, ar)),\n        by = c(\"flokkur\", \"ar\")\n    )\n\n\n\n```\n\n# Atkvæði og þingmenn\n\n```{r}\n#| fig-asp: 0.621\n#| fig-width: 10\n#| out-width: \"100%\"\n#| column: page\n#| fig-cap: \"Mynd 1. Hvaða flokkar fá flesta þingmenn fyrir hvert atkvæði?\"\n#| fig-cap-location: margin\n\n\nplot_dat <- d |> \n    select(ar, flokkur, merki, litur, thingmenn, atkvaedi) |> \n    drop_na() |> \n    group_by(ar) |> \n    mutate(p_th = thingmenn / sum(thingmenn),\n           p_at = atkvaedi / sum(atkvaedi)) |> \n    ungroup() |> \n    mutate(\n        ar = ifelse(ar == 2020, 2021, ar),\n        value = p_th / p_at,\n        merki = fct_reorder(merki, value),\n        y = value,\n        y = case_when(\n            merki == \"xC\" ~ y * 0.997,\n            merki == \"xS\" ~ y * 1.006,\n            merki == \"xD\" ~ y * 0.999,\n            TRUE ~ y\n        )\n    )\n\np <- plot_dat |> \n    ggplot(aes(ar, value)) +\n    geom_hline(yintercept = 1, lty = 2, alpha = 0.4) +\n    geom_line(aes(colour = merki)) +\n    geom_point(aes(colour = merki)) +\n    geom_text(\n        data = plot_dat |> filter(ar == max(ar)),\n        aes(label = merki, colour = merki, y = y),\n        hjust = 0,\n        vjust = 0.5,\n        nudge_x = 0.1\n    ) +\n    annotate(\n        geom = \"label\", \n        x = c(2008, 2008), \n        y = c(min(plot_dat$value), max(plot_dat$value)), \n        label = c(\"Færri þingmenn per atkvæði\", \"Fleiri þingmenn per atkvæði\"),\n        size = 4,\n        vjust = c(0, 1),\n        family = \"Lato\",\n        colour = \"#636363\"\n        \n    ) +\n    scale_x_tufte(\n        breaks = unique(plot_dat$ar),\n    ) +\n    scale_y_tufte(\n        breaks = c(tufte_breaks(plot_dat$value), 1),\n        labels = label_number(accuracy = 0.01)\n    ) +\n    scale_colour_manual(\n        values = plot_dat |> arrange(merki) |> distinct(litur) |> pull(litur)\n    ) +\n    theme(legend.position = \"none\") +\n    labs(x = NULL,\n         y = NULL,\n         title = \"Hvaða flokkar fá flesta þingmenn fyrir hvert atkvæði?\",\n         subtitle = \"Reiknað sem hlutfall þingmanna deilt með hlutfalli atkvæða til hvers flokks\",\n         caption = \"Myndrit eftir @bggjonsson byggt á niðurstöðum alþingiskosninga\")\n\nggsave(\n    plot = p + labs(caption = NULL, title = NULL, subtitle = NULL),\n    filename = \"Figures/thingmenn_atkvaedi.png\",\n    width = 8, height = 0.621 * 8,\n    scale = 1.3\n)\n\nggsave(\n    plot = p,\n    filename = \"Figures/thingmenn_atkvaedi_tw.png\",\n    width = 8, height = 0.621 * 8,\n    scale = 1.3\n)\n\nknitr::include_graphics(\"Figures/thingmenn_atkvaedi.png\")\n```\n\n\n\n\n\n# Peningar\n\nRíkisendurskoðun birtir ársreikninga stjórnmálaflokkanna. Reyndar voru bara birtir útdrættir úr ársreikningunum fram til ársins 2019, en þar eru þó nægar upplýsingar til að framkvæma ýmsar greiningar. Til dæmis getum við skoðað útgjöld stjórnmálaflokka á hverju kjörtímabili og borið það saman við fjölda atkvæða í næstu kosningum.\n\n```{r}\n#| column: screen-inset\n#| layout-nrow: 1\n#| fig-cap: \"Mynd 2. Meðaltal ársútgjalda frá síðustu kosningum deilt með fjölda atkvæða í yfirstandandi kosningum.\"\n#| fig-cap-location: margin\n\n\nplot_dat <- d |> \n    select(flokkur, ar, atkvaedi, gjold, afkoma, litur, merki, cpi) |> \n    arrange(flokkur, ar) |> \n    group_by(flokkur) |> \n    mutate(kosningar = cumsum(!is.na(atkvaedi)) |> lag(default = 0)) |> \n    group_by(flokkur, kosningar, litur, merki) |> \n    filter(any(!is.na(atkvaedi))) |> \n    summarise(\n        gjold = mean(gjold/cpi),\n        afkoma = sum(afkoma/cpi),\n        atkvaedi = na.omit(atkvaedi),\n        start_ar = min(ar),\n        end_ar = max(ar),\n        ar = max(ar),\n        .groups = \"drop\"\n    ) |> \n    filter(ar > 2007) |> \n    mutate(\n        gjold = ifelse(ar == 2020, gjold / (3/4), gjold),\n        value = gjold / atkvaedi,\n        merki = fct_reorder(merki, value),\n        ar = ifelse(ar == 2020, 2021, ar)\n    )\n\n\n\np <- plot_dat |> \n    group_by(ar2 = ar) |> \n    group_map(\n        function(data, ...) {\n            \n            data <- data |> \n                mutate(merki = fct_reorder(merki, value))\n            \n            data |> \n                mutate(y = value + 0.02 * mean(value)) |> \n                ggplot(aes(merki, value)) +\n                geom_col(aes(fill = merki)) +\n                geom_text(\n                    aes(\n                        label = merki, \n                        colour = merki,\n                        y = y\n                    ),\n                    size = 5,\n                    vjust = 0,\n                    family = \"serif\"\n                ) +\n                scale_y_tufte(\n                    breaks = tufte_breaks(data$value),\n                    expand = expansion(mult = 0.07),\n                    labels = label_number(suffix = \" kr\", big.mark = \".\", decimal.mark = \",\"),\n                    limits = c(0, max(plot_dat$value) * 1.01)\n                ) +\n                scale_colour_manual(\n                    values = data |> arrange(merki) |> distinct(litur) |> pull(litur)\n                ) + \n                scale_fill_manual(\n                    values = data |> arrange(merki) |> distinct(litur) |> pull(litur)\n                ) + \n                facet_wrap(\"ar\") +\n                theme(legend.position = \"none\",\n                      plot.tag.position = c(0.1, 0.1),\n                      axis.line.x = element_blank(),\n                      axis.text.x = element_blank(),\n                      axis.ticks.x = element_blank(),\n                      plot.margin = margin(t = 5, r = 5, b = 0, l = 5)) +\n                labs(x = NULL, y = NULL)\n        }\n    )\n\n\n# for (plot in p) print(plot)\n\np <- wrap_plots(p, nrow = 1) \n\nggsave(plot = p,\n       filename = \"Figures/kr_per_atkvaedi.png\",\n       width = 10, height = 0.25 * 10,\n       scale = 2,\n       dpi = 200)\n\np <- wrap_plots(p, nrow = 1) +\n    plot_annotation(\n        title = \"Hvað kosta atkvæðin?\",\n        subtitle = \"Meðaltal ársútgjalda frá síðustu kosningum deilt með fjölda atkvæða í yfirstandandi kosningum\",\n        caption = \"Myndrit frá bggj.is byggt á niðurstöðum alþingiskosninga og ársreikningum stjórnmálaflokka frá Ríkisendurskoðun\",\n        theme = theme(\n            plot.caption = element_text(margin = margin(t = -10, r = 0, b = 5, l = 0), size = 10),\n            plot.title = element_text(size = 25),\n            plot.subtitle = element_text(size = 18)\n        )\n    )\n\nggsave(plot = p,\n       filename = \"Figures/kr_per_atkvaedi_tw.png\",\n       width = 10, height = 0.25 * 10,\n       scale = 2,\n       dpi = 200)\n\nknitr::include_graphics(\"Figures/kr_per_atkvaedi.png\")\n```\n\n\n\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":false,"freeze":true,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../style.css"],"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.175","editor":"source","theme":["paper","../../theme.scss"],"title-block-banner":true,"title":"Alþingiskosningar","pagetitle":"Alþingiskosningar","subtitle":"A subtitle","description":"A description of this stuff!\n","author":[{"name":"Brynjólfur Gauti Guðrúnar Jónsson","url":"https://twitter.com/bgautijonsson","affiliation":"Tölfræði, Raunvísindadeild Háskóla Íslands","affiliation-url":"https://www.hi.is/tolfraedi_0"}],"date":"2022/09/17","draft":false,"categories":["stjórnmál","kosningar","R","íslenska"],"href":"posts/kosningar/index.qmd","image":"Figures/thingmenn_atkvaedi_tw.png","page-layout":"full","smooth-scroll":true},"extensions":{"book":{"multiFile":true}}}}}